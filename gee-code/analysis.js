/**
 * Author: Lorena Abad (lorena.abad@plus.ac.at; @loreabad6)
 * 
 * This code is free and open, under an MIT license:
 * https://github.com/loreabad6/KaikouraDammedLakes_public/blob/master/LICENSE
 */ 

var s2 = ee.ImageCollection("COPERNICUS/S2"),
    kaikoura = ee.FeatureCollection("users/loreabad6/NZ/AOI/North_Canterbury_AOI_WGS84"),
    gsw = ee.ImageCollection("JRC/GSW1_3/MonthlyHistory"),
    nz_vdist = ee.Image("users/loreabad6/NZ/preprocessed_layers/vertical_distance_channel_network_kaikoura"),
    keydams = ee.FeatureCollection("users/loreabad6/NZ/ref_data/nc_key_dams_wgs84"),
    otherdams = ee.FeatureCollection("users/loreabad6/NZ/ref_data/nc_other_dams_wgs84"),
    nz_river = ee.FeatureCollection("users/loreabad6/NZ/ref_data/nz-river-centrelines-topo-150k"),
    nz_lake = ee.FeatureCollection("users/loreabad6/NZ/ref_data/nz-lake-polygons-topo-150k"),
    coast = ee.FeatureCollection("users/loreabad6/NZ/ref_data/nz-coastlines-topo-150k"),
    epicentre = 
    /* color: #993dff */
    /* shown: false */
    ee.Geometry.Point([173.077, -42.757]),
    dem = ee.Image("users/loreabad6/NZ/preprocessed_layers/dem_nosinks_kaikoura"),
    validation_areas = 
    /* color: #e4e4e4 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[173.10287838178687, -42.55316388445944],
                  [173.10287838178687, -42.62115925775743],
                  [173.267158319531, -42.62115925775743],
                  [173.267158319531, -42.55316388445944]]], null, false),
            {
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.66288203694336, -42.21741270456139],
                  [173.66288203694336, -42.25134795557224],
                  [173.73480815388672, -42.25134795557224],
                  [173.73480815388672, -42.21741270456139]]], null, false),
            {
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.76845538696287, -41.9498620604174],
                  [173.76845538696287, -41.9707964573212],
                  [173.81652057250975, -41.9707964573212],
                  [173.81652057250975, -41.9498620604174]]], null, false),
            {
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.58065784057615, -42.214697519528556],
                  [173.58065784057615, -42.29195008565546],
                  [173.74407947143553, -42.29195008565546],
                  [173.74407947143553, -42.214697519528556]]], null, false),
            {
              "system:index": "3"
            })]),
    Delineated_Lakes_0318 = 
    /* color: #ff93fc */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[173.2127845783811, -42.586994301330954],
                  [173.21276601670323, -42.58667256903706],
                  [173.2128947628773, -42.586388198515024],
                  [173.21286257622776, -42.58610382735639],
                  [173.2131200682932, -42.585756260441585],
                  [173.21281966088353, -42.58553508048685],
                  [173.21217593071995, -42.585503483286395],
                  [173.21185406589916, -42.58552718144446],
                  [173.2116609465891, -42.585629871992104],
                  [173.21131762383519, -42.58547188606993],
                  [173.2112103354746, -42.58517961105841],
                  [173.21058806298313, -42.58515591302443],
                  [173.2097726714426, -42.58521910776165],
                  [173.20891436455784, -42.58525070510625],
                  [173.2081526171976, -42.58506112079849],
                  [173.20732649682103, -42.58499792590113],
                  [173.20706900437492, -42.58483203933305],
                  [173.2067256820017, -42.58483993837745],
                  [173.20658620713291, -42.58462665458538],
                  [173.2065915716478, -42.584393621056485],
                  [173.2065647494608, -42.58413688904201],
                  [173.20633944390354, -42.58367081825852],
                  [173.20617851136265, -42.583568124227625],
                  [173.20527728913365, -42.58359972240899],
                  [173.2049446952158, -42.583441731342],
                  [173.20484813544658, -42.58317314549712],
                  [173.20453699944554, -42.58313364760976],
                  [173.2041507613474, -42.582944056864],
                  [173.203968370906, -42.582841361824684],
                  [173.2037001502329, -42.58281766271319],
                  [173.2035070319016, -42.58297565577855],
                  [173.20307787774144, -42.58300725384331],
                  [173.20267554682255, -42.583169196478025],
                  [173.20227321503697, -42.58314154721166],
                  [173.2019728079862, -42.58322054340328],
                  [173.20174750207005, -42.58339433394383],
                  [173.20135053488167, -42.583390384365096],
                  [173.20127543328343, -42.58326004111998],
                  [173.20083555100499, -42.58322054317557],
                  [173.20041712639866, -42.58332323777899],
                  [173.20008453248082, -42.58354442558109],
                  [173.19983240527523, -42.583607622430385],
                  [173.19931205628453, -42.583631320574355],
                  [173.19863613961277, -42.583647119651026],
                  [173.19808896897374, -42.583639220113184],
                  [173.19800581996415, -42.583718215758886],
                  [173.1983518246633, -42.58376561313709],
                  [173.19855299050187, -42.58387620647783],
                  [173.19896873353062, -42.58386040679422],
                  [173.19951590416966, -42.58392360284468],
                  [173.200116718989, -42.58392360284468],
                  [173.20015963433323, -42.583844607771596],
                  [173.20036884635232, -42.583876205615795],
                  [173.2004063975626, -42.583781411641084],
                  [173.20071216907832, -42.58363132085925],
                  [173.20102598755904, -42.58377746205039],
                  [173.20142563698826, -42.58373401450112],
                  [173.2020800959879, -42.58375771307563],
                  [173.20243414803736, -42.58389200508119],
                  [173.20273455498753, -42.583963100343674],
                  [173.20307787774144, -42.58392360284468],
                  [173.2031207934663, -42.58396310068601],
                  [173.20346411583958, -42.58397099984047],
                  [173.2038932686213, -42.58399074913549],
                  [173.20423659203587, -42.58410529113287],
                  [173.20448335498244, -42.584204035037025],
                  [173.20492323754368, -42.584207984278954],
                  [173.2052236446869, -42.58425538105855],
                  [173.20522364495335, -42.58442916894211],
                  [173.20504125480562, -42.5845318612684],
                  [173.20508417008458, -42.58491893218933],
                  [173.2054006701821, -42.585100617732586],
                  [173.2056098830515, -42.585187510401056],
                  [173.20599612114964, -42.58547188606993],
                  [173.20621069718564, -42.58567726792093],
                  [173.20659693596897, -42.585756260441585],
                  [173.20691880105076, -42.586056431982115],
                  [173.20745524285374, -42.58626181167707],
                  [173.20779856552065, -42.58624601377349],
                  [173.20814188836155, -42.58629340849316],
                  [173.20857104180394, -42.58626181167707],
                  [173.20868905880485, -42.586372400593405],
                  [173.20895727990208, -42.586388198845334],
                  [173.20938643334446, -42.586577779117285],
                  [173.20964392580143, -42.58659357766346],
                  [173.20990141747532, -42.586388198845334],
                  [173.21034129975376, -42.586238114054495],
                  [173.2108348262125, -42.586238114054495],
                  [173.2108884701909, -42.586344753820015],
                  [173.21154292939244, -42.58634870288278],
                  [173.2119506251627, -42.58635660207729],
                  [173.21226176140843, -42.58676735881269]]]),
            {
              "lakes": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.21351279283866, -42.58781885289243],
                  [173.21353425051078, -42.588024226780874],
                  [173.21370591188773, -42.58815061037591],
                  [173.2137702849041, -42.58827699371471],
                  [173.21415652300223, -42.58829279161403],
                  [173.21439255739554, -42.58821380207734],
                  [173.21428526903495, -42.58800842881348],
                  [173.21404923464164, -42.58785044891931],
                  [173.2137917425762, -42.587803054872985]]]),
            {
              "lakes": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.17620595116577, -42.60477904747209],
                  [173.17624886651, -42.6046369038441],
                  [173.17624886651, -42.60439999707674],
                  [173.1757982553955, -42.60443158469778],
                  [173.1759055437561, -42.6047316662988]]]),
            {
              "lakes": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.17665656228027, -42.60428944027701],
                  [173.17704280037842, -42.604257852583906],
                  [173.17704280037842, -42.60444737850229],
                  [173.17732175011596, -42.60435261561518],
                  [173.17764361519775, -42.60427364643245],
                  [173.17794402260742, -42.60427364643245],
                  [173.17809422631225, -42.60421047101423],
                  [173.1782658876892, -42.60417888328107],
                  [173.17822297234497, -42.604020944375115],
                  [173.1782444300171, -42.60375244731607],
                  [173.17828734536133, -42.60356291928358],
                  [173.17845900673828, -42.60338918474731],
                  [173.17843754906616, -42.60318386148889],
                  [173.17867358345947, -42.60297853755381],
                  [173.178587752771, -42.602725830243244],
                  [173.178587752771, -42.602504710505684],
                  [173.17863066811523, -42.60222041254709],
                  [173.17880232949219, -42.60199929101574],
                  [173.17880232949219, -42.60168340175248],
                  [173.1788237871643, -42.601209564854614],
                  [173.17890961785278, -42.60098843973572],
                  [173.1792743982788, -42.600846287459184],
                  [173.17921002526245, -42.60068834010487],
                  [173.1789310755249, -42.60068834010487],
                  [173.17875941414795, -42.60079890329493],
                  [173.17863066811523, -42.60097264505435],
                  [173.178587752771, -42.60117797559997],
                  [173.1786092104431, -42.60135171630235],
                  [173.17850192208252, -42.60149386742576],
                  [173.17839463372192, -42.60169919625368],
                  [173.17839463372192, -42.601809757649974],
                  [173.1782658876892, -42.60199929101574],
                  [173.1782444300171, -42.60217302942787],
                  [173.1781585993286, -42.602362561688544],
                  [173.17807276864013, -42.602599476203594],
                  [173.17805131096802, -42.60282059560483],
                  [173.17796548027954, -42.60296274337693],
                  [173.17775090355835, -42.603152273235224],
                  [173.177686530542, -42.60329442025058],
                  [173.1775792421814, -42.603594507329035],
                  [173.1773646654602, -42.60383141715944],
                  [173.17706425805054, -42.603957768700624],
                  [173.17687113900146, -42.60409991387814]]]),
            {
              "lakes": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.16241066843247, -42.59759249112891],
                  [173.16241066843247, -42.59702384908644],
                  [173.1619815149901, -42.596960666316974],
                  [173.16180985361314, -42.59727657952372],
                  [173.16180985361314, -42.59775044633092],
                  [173.16206734567857, -42.598161127982316],
                  [173.16232483852724, -42.59816112746179]]]),
            {
              "lakes": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.16260378748154, -42.596123488573554],
                  [173.16262524515366, -42.59594973329291],
                  [173.16281836420274, -42.59574438551845],
                  [173.16318314462876, -42.59550744493789],
                  [173.1634406366942, -42.59530209570601],
                  [173.1635479250548, -42.59503356107412],
                  [173.1635479250548, -42.59482821028073],
                  [173.16337626367783, -42.59479661779092],
                  [173.1631187716124, -42.59498617248954],
                  [173.16275399118638, -42.59530209570601],
                  [173.1625608721373, -42.595491648867146],
                  [173.16236775308823, -42.59563381335963],
                  [173.16219609171128, -42.59587075345974],
                  [173.16230338007188, -42.59609189674039]]]),
            {
              "lakes": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.12606137186268, -42.6101013032155],
                  [173.12640469461658, -42.61013288794564],
                  [173.12681239038685, -42.61013288794564],
                  [173.12702696710804, -42.610038133707185],
                  [173.1271449845345, -42.609872313443056],
                  [173.12726300150135, -42.60975387012697],
                  [173.12741320520618, -42.60937485000199],
                  [173.12745612055042, -42.609169546471335],
                  [173.1276706972716, -42.60902741286138],
                  [173.128099850714, -42.60875893737994],
                  [173.12827151209095, -42.60834832558182],
                  [173.12835734277942, -42.608079847173435],
                  [173.1287864962218, -42.60782716055553],
                  [173.12837880045154, -42.607811367607866],
                  [173.12818568140247, -42.607637644919414],
                  [173.12784235864856, -42.607353370384175],
                  [173.12779944330433, -42.60708488768748],
                  [173.12756340891102, -42.60684799022941],
                  [173.12734883218982, -42.60667426485426],
                  [173.12734883218982, -42.606942749320744],
                  [173.12756340891102, -42.60729019808905],
                  [173.1277779856322, -42.60759026592031],
                  [173.12786381632068, -42.607906125233725],
                  [173.1278852739928, -42.608190397246446],
                  [173.12760632425525, -42.60844308239086],
                  [173.12739174753406, -42.608616802833055],
                  [173.12706988245228, -42.60867997378283],
                  [173.12685530573108, -42.60880631549016],
                  [173.1268767634032, -42.60905899813607],
                  [173.1267480173705, -42.60918533907464],
                  [173.12636177927234, -42.6091379612527],
                  [173.12599699884632, -42.60905899813607],
                  [173.12567513376453, -42.60893265694125],
                  [173.12546055704334, -42.608869486247734],
                  [173.12548201471546, -42.60907479076741],
                  [173.12584679514148, -42.60934326488748],
                  [173.12614720255115, -42.60950119029991],
                  [173.12634032160022, -42.60962753034158],
                  [173.1261901178954, -42.60980124748043]]]),
            {
              "lakes": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.15098045724503, -42.615328144951135],
                  [173.15131305116287, -42.61517812985464],
                  [173.15174220460526, -42.61519392093445],
                  [173.15243957894913, -42.61517812985464],
                  [173.15289019006363, -42.615004427712464],
                  [173.15341590303055, -42.6146886043945],
                  [173.15364657422967, -42.61443989243435],
                  [173.15395502802386, -42.61433922309865],
                  [173.15407036203018, -42.614222762077],
                  [173.15378068345657, -42.61419117942085],
                  [173.1533515300142, -42.61438857075892],
                  [173.153136953293, -42.61456227461885],
                  [173.15300820726029, -42.614720186798365],
                  [173.15265415567032, -42.61488599415593],
                  [173.15227864640823, -42.614941263177],
                  [173.1519138659822, -42.614949158747436],
                  [173.15159200090042, -42.61490968088525],
                  [173.15131305116287, -42.614941263177],
                  [173.1511413898757, -42.615004427755],
                  [173.15096972840897, -42.615067592183856],
                  [173.1508517112123, -42.61517812985464],
                  [173.15083025346266, -42.615276824010586]]]),
            {
              "lakes": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.19039175198915, -42.611581846372296],
                  [173.19048831157153, -42.611648962332936],
                  [173.19092819384997, -42.611648962332936],
                  [173.19114277057116, -42.61154631440002],
                  [173.1913680761284, -42.61152262639148],
                  [173.1915826528496, -42.611530522395334],
                  [173.1917865009381, -42.611518678632805],
                  [173.19207617930834, -42.61142787426722],
                  [173.19170067004626, -42.611380498151036],
                  [173.19144317798083, -42.61130153787731],
                  [173.19098183803027, -42.61132522596995],
                  [173.19070825285667, -42.61133707018804],
                  [173.19056341342394, -42.6114120822325],
                  [173.19038102321093, -42.61151473038664]]]),
            {
              "lakes": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.2004737929346, -42.61302961712712],
                  [173.2007634715082, -42.612998033865914],
                  [173.20077420034426, -42.61280853396239],
                  [173.20080638685243, -42.61258745001286],
                  [173.20096731939333, -42.612540074778714],
                  [173.20107460775392, -42.61241374064482],
                  [173.2011604384424, -42.61231109397233],
                  [173.2011604384424, -42.612192655293875],
                  [173.20106387891786, -42.612129487906586],
                  [173.20102096357363, -42.61222423896347],
                  [173.20088148870485, -42.61231898987623],
                  [173.20069909849184, -42.61242163653569],
                  [173.2006561831476, -42.612516387148126],
                  [173.2006561831476, -42.61264272107382],
                  [173.20057035245912, -42.61276115889641],
                  [173.20051670827883, -42.61288749232559]]]),
            {
              "lakes": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.24648524268304, -42.569075301948025],
                  [173.24665690406, -42.56901209084844],
                  [173.24675346358453, -42.568940978284814],
                  [173.24682856543694, -42.568830358580264],
                  [173.24686075194512, -42.56871183725056],
                  [173.24687148078118, -42.56854590701064],
                  [173.24685002310906, -42.56840368073938],
                  [173.24685002310906, -42.568245651168766],
                  [173.24677492125664, -42.568190340724456],
                  [173.24666763289605, -42.56826935562988],
                  [173.24665690406, -42.56838787780033],
                  [173.24665690406, -42.568538005559624],
                  [173.24664617522393, -42.56871183725056],
                  [173.2465710733715, -42.56885406281919],
                  [173.24648524268304, -42.568940978284814]]]),
            {
              "lakes": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.24732209189568, -42.56498225104174],
                  [173.2473971937481, -42.564776801253906],
                  [173.24751521094475, -42.564666174164834],
                  [173.24751521094475, -42.56453184100722],
                  [173.24733282073174, -42.56450813512585],
                  [173.2472362612072, -42.56460295859728],
                  [173.2472148035351, -42.56472148773389],
                  [173.2471826170269, -42.56481631088103],
                  [173.2471289728466, -42.5649427415197]]]),
            {
              "lakes": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.2640675706083, -42.55822730383844],
                  [173.26438943569008, -42.55815617898083],
                  [173.2647273941788, -42.55806924873003],
                  [173.2650760811979, -42.55807715126615],
                  [173.2652370141192, -42.55800602633951],
                  [173.26550523464027, -42.55787958154167],
                  [173.26577345574825, -42.55787563022373],
                  [173.26582709972206, -42.55768201119163],
                  [173.26535503093544, -42.55745282880192],
                  [173.26484004680458, -42.55726315998078],
                  [173.2644108933622, -42.55707349058314],
                  [173.2647005719358, -42.55731057724011],
                  [173.26488296182274, -42.55747653723587],
                  [173.264915148657, -42.55771362248968],
                  [173.26458255473915, -42.55787958154167],
                  [173.2641212147886, -42.55806134571123],
                  [173.26387981636958, -42.558199644164205],
                  [173.26376716319862, -42.5583379423447],
                  [173.2638690872795, -42.558349796614856]]]),
            {
              "lakes": 1,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.26224235074352, -42.55565030415365],
                  [173.26237109677623, -42.555444823636215],
                  [173.26224235074352, -42.5552551487119],
                  [173.26202777402233, -42.55528676123931],
                  [173.2620063163502, -42.55550804848288]]]),
            {
              "lakes": 1,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.26270905496537, -42.55443321740975],
                  [173.2629236318333, -42.55442531413976],
                  [173.2629933692677, -42.554279104048],
                  [173.26302555581657, -42.55417636150585],
                  [173.2630148269398, -42.554022247651936],
                  [173.26306310670208, -42.55387603661587],
                  [173.26307919995617, -42.5536745019236],
                  [173.263009462337, -42.55346901478804],
                  [173.2629075385792, -42.55340578798822],
                  [173.26284316556286, -42.553658695253546],
                  [173.26280025021862, -42.553895794884],
                  [173.2626715041859, -42.554117087059744],
                  [173.26262858884166, -42.55430676544298]]]),
            {
              "lakes": 1,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.18753865021273, -42.62009415321551],
                  [173.18782832878634, -42.62009415321551],
                  [173.18809654968783, -42.620109943048725],
                  [173.18819310921236, -42.62017310234151],
                  [173.18843987244173, -42.6201809972486],
                  [173.1885257031302, -42.620078363378305],
                  [173.18827893990084, -42.61995204453647],
                  [173.18813946503207, -42.620015203989425],
                  [173.18803217667147, -42.61990467490471],
                  [173.18782832878634, -42.61987309513019],
                  [173.18768885391756, -42.619936254663216],
                  [173.18750646370455, -42.619991519202074]]]),
            {
              "lakes": 1,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.67196216557116, -42.2435780161806],
                  [173.67249860737414, -42.24354624622286],
                  [173.67286338780016, -42.2433397411076],
                  [173.6732496258983, -42.24324443082644],
                  [173.6735929486522, -42.24311735022758],
                  [173.67410793278307, -42.24327620093615],
                  [173.67440834019274, -42.24341916623191],
                  [173.67477312061877, -42.24345093625365],
                  [173.6752666470775, -42.243387396194194],
                  [173.67552413914294, -42.24327620093615],
                  [173.67576017353625, -42.24302203961046],
                  [173.67573871586413, -42.242720221706385],
                  [173.67541685078234, -42.24259314005168],
                  [173.6751379010448, -42.24245017288418],
                  [173.67496623966784, -42.24227543479507],
                  [173.67462291691393, -42.24216423757731],
                  [173.67432250950426, -42.24227543479507],
                  [173.67393627140612, -42.24233897597437],
                  [173.6735929486522, -42.24233897597437],
                  [173.67333545658678, -42.24214835224449],
                  [173.6727990147838, -42.242037154802766],
                  [173.67239131901354, -42.2420689255204],
                  [173.67217674229235, -42.24213246690767],
                  [173.67198362324328, -42.242180122906134],
                  [173.67174758884997, -42.2422913200959],
                  [173.67153301212878, -42.24252959912834],
                  [173.67142572376818, -42.242783762437746],
                  [173.6714471814403, -42.24306969493702],
                  [173.67159738514513, -42.24324443082644],
                  [173.67164030048937, -42.24345093625365]]]),
            {
              "lakes": 1,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.1538002857196, -42.58769011481591],
                  [173.15319947090026, -42.587310960461124],
                  [173.15294197883483, -42.587058189610055],
                  [173.15251282539245, -42.586931803800134],
                  [173.15238407935973, -42.587121382418914],
                  [173.15285614814636, -42.587532134115015],
                  [173.1532423862445, -42.587626922583596]]]),
            {
              "lakes": 1,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.20071010801703, -42.58437051656536],
                  [173.20109634611518, -42.584528505278655],
                  [173.2015684149018, -42.58437051656536],
                  [173.2015684149018, -42.584086135872475],
                  [173.20105343077094, -42.584086135872475]]]),
            {
              "lakes": 1,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.29941543790497, -42.52021225755468],
                  [173.29968365831155, -42.520342732600334],
                  [173.29999479505219, -42.52042576158531],
                  [173.30048832151093, -42.520394131404586],
                  [173.30082091542877, -42.52020434998398],
                  [173.3013144421808, -42.52010155210426],
                  [173.30155047628082, -42.52006992112896],
                  [173.3017221382016, -42.519943402263415],
                  [173.30161485042012, -42.519864329013245],
                  [173.30104622299694, -42.52005015959517],
                  [173.3006117050664, -42.52013912013847],
                  [173.30040517453278, -42.52027849053075],
                  [173.30011281314498, -42.52034669213993],
                  [173.29997333721911, -42.52027947557834],
                  [173.29981776885677, -42.52028540489497]]]),
            {
              "lakes": 1,
              "system:index": "19"
            })]),
    Delineated_Lakes_1216 = 
    /* color: #8dd292 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[173.2125381377271, -42.586814224389116],
                  [173.21286000330917, -42.58682212338802],
                  [173.21288146048101, -42.586450863072955],
                  [173.21290291836524, -42.586134894669144],
                  [173.21288146048101, -42.585787328247854],
                  [173.21281708711666, -42.58558194698969],
                  [173.2125381377271, -42.58553455121865],
                  [173.2120660689405, -42.58553455121865],
                  [173.2114223387769, -42.585502954017926],
                  [173.21116484671148, -42.58506059152627],
                  [173.21034945517096, -42.58509218895121],
                  [173.20970572500738, -42.58521857849077],
                  [173.20876158743414, -42.585250175835625],
                  [173.208375349336, -42.58509218895121],
                  [173.20764578848394, -42.58506059152627],
                  [173.20683039694342, -42.5849026041614],
                  [173.20661582022223, -42.584618225895674],
                  [173.206572904878, -42.58420745499948],
                  [173.20631541281256, -42.58389147554531],
                  [173.2059291747144, -42.58373348521766],
                  [173.20511378317389, -42.583670288974496],
                  [173.2045558836988, -42.58341750336123],
                  [173.2041267302564, -42.583101519903316],
                  [173.20374049215826, -42.58297512607173],
                  [173.2032255080274, -42.58300672455365],
                  [173.20279635458502, -42.583164716723026],
                  [173.20223845510992, -42.58325951183245],
                  [173.20163764029058, -42.58329111017025],
                  [173.20095099478277, -42.58332270849202],
                  [173.20035017996344, -42.58354389629599],
                  [173.2001890054294, -42.5837159512512],
                  [173.2007092393756, -42.58369139122403],
                  [173.20116986350916, -42.58365048778884],
                  [173.2015446559827, -42.583546386525164],
                  [173.20199383410815, -42.5836541635859],
                  [173.20237720815174, -42.5838065186302],
                  [173.20275771882598, -42.58382684267237],
                  [173.20313250265943, -42.58383588905804],
                  [173.20330271378052, -42.583822381695896],
                  [173.20364313732406, -42.58385855900941],
                  [173.20389483079273, -42.58383611607928],
                  [173.20414072826944, -42.58391761895362],
                  [173.2044179491153, -42.583985826352475],
                  [173.20458615840172, -42.58415383658974],
                  [173.204965492341, -42.584110674980586],
                  [173.20520918071432, -42.58421393488793],
                  [173.2053532418923, -42.58438885444707],
                  [173.20538387720754, -42.58451750872315],
                  [173.2051876591479, -42.584648430931466],
                  [173.20535313006624, -42.58481548006331],
                  [173.2055553346195, -42.58499158741098],
                  [173.2058310112565, -42.585249005689434],
                  [173.20612488212666, -42.585384668030294],
                  [173.20649806347967, -42.58562438910928],
                  [173.20685820028805, -42.58575625435477],
                  [173.2072351696792, -42.58598838075127],
                  [173.2074741351445, -42.586105061288144],
                  [173.20782333120428, -42.58618042851281],
                  [173.20809256926339, -42.5860783773332],
                  [173.20828773323234, -42.58619023973131],
                  [173.20859224082903, -42.58625597107825],
                  [173.20890084912787, -42.58616624320005],
                  [173.20913183937617, -42.58627115286779],
                  [173.20942217042065, -42.58635457562638],
                  [173.20970242951267, -42.586331829062274],
                  [173.2099625377751, -42.58622312963025],
                  [173.21018234688398, -42.58616370459079],
                  [173.21057906082777, -42.58620282288525],
                  [173.2109433387407, -42.58615465508791],
                  [173.21124275768335, -42.58627948649436],
                  [173.21158411040201, -42.5862763585524],
                  [173.21183766998325, -42.586301687861905],
                  [173.21208730700064, -42.586352335296354],
                  [173.2123663226243, -42.586506302789644]]]),
            {
              "lakes": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.20112265615973, -42.58450763399757],
                  [173.20129431753668, -42.584412840785895],
                  [173.2015518096021, -42.58439704190327],
                  [173.20170201330694, -42.584254851779484],
                  [173.20189513235601, -42.58412846028609],
                  [173.2017663863233, -42.583938872565525],
                  [173.20135869055304, -42.58400206853644],
                  [173.20112265615973, -42.58408106341],
                  [173.20082224875006, -42.58409686237269],
                  [173.20088662176641, -42.58433384633273]]]),
            {
              "lakes": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.16250441149364, -42.59784610120542],
                  [173.16241858080517, -42.59754598643997],
                  [173.16263315752636, -42.597277461477255],
                  [173.16252586916576, -42.59691416115651],
                  [173.16254732683788, -42.59670881656003],
                  [173.1621181733955, -42.596740408080464],
                  [173.16198942736278, -42.59708791374808],
                  [173.16186068133007, -42.59735643952758],
                  [173.16183922365795, -42.597672350727905],
                  [173.16192505434643, -42.59794087398896],
                  [173.16226837710033, -42.5981304191236]]]),
            {
              "lakes": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.16484329775463, -42.59366015949621],
                  [173.16419956759106, -42.59370754908909],
                  [173.16387770250927, -42.5938497176515],
                  [173.16366312578808, -42.59408666453482],
                  [173.16362021044384, -42.59438679596043],
                  [173.16355583742748, -42.594497370331844],
                  [173.16344854906689, -42.594671129661954],
                  [173.1632339723457, -42.594987054475496],
                  [173.1628906495918, -42.59509762778186],
                  [173.16244003847729, -42.595539919045464],
                  [173.16228983477245, -42.59572947148322],
                  [173.16203234270702, -42.595919023344415],
                  [173.1623327501167, -42.59609277871069],
                  [173.16259024218212, -42.59618755416082],
                  [173.16286919191967, -42.59574526749367],
                  [173.1630193956245, -42.59555571510397],
                  [173.16321251467357, -42.59541355043333],
                  [173.16362021044384, -42.59514501628168],
                  [173.16387770250927, -42.59495546206621],
                  [173.1641351945747, -42.594702722215374],
                  [173.16432831362377, -42.59435520324686],
                  [173.16439268664013, -42.59416564662906],
                  [173.16486475542675, -42.59391290357513]]]),
            {
              "lakes": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.14927009040107, -42.585547713835425],
                  [173.14933446343917, -42.585918979719935],
                  [173.1493773787888, -42.586187553657275],
                  [173.14957049786236, -42.58634553778577],
                  [173.14998892252171, -42.586637807368],
                  [173.15024641461983, -42.58677999207473],
                  [173.15067556811655, -42.58689847908258],
                  [173.15105107742625, -42.58694587382267],
                  [173.1515016885978, -42.587024864976044],
                  [173.15161970576597, -42.58713545254878],
                  [173.15178063837075, -42.587151250613296],
                  [173.15204885907787, -42.58720654443769],
                  [173.15229562256687, -42.58718284698257],
                  [173.1525960300146, -42.58735662672728],
                  [173.15283206443777, -42.58754620407811],
                  [173.15321830258483, -42.58770418476334],
                  [173.1537440156184, -42.58771998280984],
                  [173.15415296732797, -42.587796135194],
                  [173.1542722411119, -42.58784069087558],
                  [173.1544249585862, -42.58791400383821],
                  [173.15462310636, -42.588029033142],
                  [173.15478336867764, -42.58811690935993],
                  [173.1549751482632, -42.58815047931417],
                  [173.1547364325835, -42.58798065061583],
                  [173.15449503423778, -42.587846367037756],
                  [173.15413025376552, -42.587633093504515],
                  [173.15392104115753, -42.58765284121968],
                  [173.15359381189455, -42.58754620407811],
                  [173.15330413328422, -42.58738822299245],
                  [173.15302518351137, -42.58721444333581],
                  [173.15281060676296, -42.587056461409404],
                  [173.15246728396556, -42.58697747029601],
                  [173.15220979186748, -42.58697747029604],
                  [173.15195229969734, -42.58707225969859],
                  [173.15185574024215, -42.58691427733326],
                  [173.15160897697206, -42.586835286039744],
                  [173.15115836580043, -42.586629908208124],
                  [173.15087941602758, -42.58651931986469],
                  [173.1507077546288, -42.58639293294625],
                  [173.15021422810753, -42.58629814258927],
                  [173.14995673600947, -42.586171755222395],
                  [173.14978507461078, -42.586013770653466],
                  [173.14974215903814, -42.58580838995315],
                  [173.14961341321208, -42.58569780031449],
                  [173.14935592111402, -42.58538182837403]]]),
            {
              "lakes": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.1054904786809, -42.58425092272901],
                  [173.10568359772998, -42.58399813947003],
                  [173.10564068238574, -42.5834451725177],
                  [173.10555485169726, -42.583113389992086],
                  [173.10510424058276, -42.58287640139279],
                  [173.10452488343554, -42.58287640139279],
                  [173.1041386453374, -42.582892200660766],
                  [173.10433176438647, -42.583081791564226],
                  [173.10476091782886, -42.58327138189115],
                  [173.10497549455005, -42.5834451725177],
                  [173.1048252908452, -42.58360316357597],
                  [173.1050398675664, -42.58371375707855],
                  [173.10521152894336, -42.583871747456186],
                  [173.1052544442876, -42.58414033017932],
                  [173.10529735963183, -42.58432991728724]]]),
            {
              "lakes": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.26438116153182, -42.557249025948586],
                  [173.2645742805809, -42.55737547192204],
                  [173.26478885730208, -42.55753352902855],
                  [173.26496051867903, -42.557707391383325],
                  [173.2647030266136, -42.55775480830509],
                  [173.2643597038597, -42.55788125325366],
                  [173.2639305504173, -42.55794447563187],
                  [173.26363014300765, -42.558165753451156],
                  [173.26315807422102, -42.55838703048576],
                  [173.26375888904036, -42.558450252351534],
                  [173.26418804248274, -42.558228975541105],
                  [173.26474594195784, -42.558102531297145],
                  [173.26528238376082, -42.55799189237349],
                  [173.26586174090804, -42.55784964204055],
                  [173.26553987582625, -42.55764416876491],
                  [173.26525019672133, -42.557557237680086],
                  [173.2650463493675, -42.55737547192204],
                  [173.26466011126936, -42.557154191300356]]]),
            {
              "lakes": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.2585400266294, -42.557127058820065],
                  [173.25830399223608, -42.557048029802075],
                  [173.25807868667883, -42.556961097766695],
                  [173.2579821271543, -42.55687416561021],
                  [173.25777827926916, -42.55672400978195],
                  [173.25757443138403, -42.55660546545178],
                  [173.2573705834989, -42.55661336841415],
                  [173.25748860069555, -42.55673981567562],
                  [173.25764953323645, -42.55687416561021],
                  [173.25786410995764, -42.556961097766695],
                  [173.25807868667883, -42.557071738517976],
                  [173.25823961921972, -42.55715867039923],
                  [173.2584541959409, -42.5571823790731]]]),
            {
              "lakes": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.26277791687292, -42.55440049986277],
                  [173.2628637475614, -42.5541950152302],
                  [173.26288520523352, -42.55400533650731],
                  [173.26288520523352, -42.553768237293006],
                  [173.26267062851232, -42.55384727046453],
                  [173.26260625549597, -42.55413178905329],
                  [173.26260625549597, -42.554321467391865],
                  [173.26282083221716, -42.55451114515393]]]),
            {
              "lakes": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.11534890053255, -42.56682298976999],
                  [173.1155205619095, -42.56666495619487],
                  [173.11537035820467, -42.566522725634954],
                  [173.11500557777865, -42.566475315376245],
                  [173.11466225502474, -42.566475315376245],
                  [173.11429747459871, -42.566522725634954],
                  [173.11386832115633, -42.566570135857624],
                  [173.1136108290909, -42.566570135857624],
                  [173.11373957512362, -42.566743973032466],
                  [173.11403998253328, -42.56685459643697],
                  [173.1143833052872, -42.566838793105475],
                  [173.11464079735262, -42.56671236630943],
                  [173.11500557777865, -42.566728169672956]]]),
            {
              "lakes": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.2464489040194, -42.569138522163975],
                  [173.24669566724876, -42.56893308606429],
                  [173.24690962098322, -42.56883835913703],
                  [173.24690962098322, -42.56861711916779],
                  [173.2468345191308, -42.568380075472824],
                  [173.2468345191308, -42.56816673537717],
                  [173.24675941727838, -42.567985000646104],
                  [173.24670577309809, -42.56820624285734],
                  [173.24668431542597, -42.56846699159891],
                  [173.24666285775385, -42.56866452779868],
                  [173.2465984847375, -42.568814654892144],
                  [173.24645900986872, -42.56897268302123]]]),
            {
              "lakes": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.24719929955683, -42.56495864448047],
                  [173.24743533395014, -42.56490333112168],
                  [173.24758553765497, -42.5648085081068],
                  [173.24756407998285, -42.56469788107395],
                  [173.2474460627862, -42.56459515579637],
                  [173.247231486065, -42.564579351892476],
                  [173.24716711304865, -42.56472948881764],
                  [173.24714565537653, -42.56487962538147]]]),
            {
              "lakes": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.14133146544972, -42.60675455162627],
                  [173.1413636519579, -42.606951966533316],
                  [173.14134219428578, -42.60708620831276],
                  [173.1412563635973, -42.607204656701434],
                  [173.14124563476125, -42.60732310486489],
                  [173.14129927894155, -42.607417863233486],
                  [173.14137438079396, -42.60732310486489],
                  [173.14142802497426, -42.60718096704172],
                  [173.14151385566274, -42.60700724259518],
                  [173.14154604217092, -42.60690458701268],
                  [173.14143875381032, -42.60677034484184]]]),
            {
              "lakes": 1,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.187586929975, -42.620078363378305],
                  [173.18787124413058, -42.620078363378305],
                  [173.18833794849917, -42.620169154887584],
                  [173.18854716080233, -42.62013362779103],
                  [173.18866651913163, -42.62016125998296],
                  [173.18867858906702, -42.620102048107],
                  [173.18867993013106, -42.62004283620953],
                  [173.1885954405646, -42.620015203989425],
                  [173.18828430428556, -42.620030994142574],
                  [173.18806972759768, -42.61999941413219],
                  [173.18801876561872, -42.61994414957246],
                  [173.1880536343436, -42.61988099007532],
                  [173.18776395576998, -42.619825725438375],
                  [173.18766739624544, -42.61994414960035],
                  [173.18753865021273, -42.61997572933883]]]),
            {
              "lakes": 1,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.67210992884654, -42.24437591229593],
                  [173.6722815902235, -42.24412175540033],
                  [173.6723888785841, -42.24397879169662],
                  [173.6725176246168, -42.24375640306916],
                  [173.67264637064952, -42.24364520846147],
                  [173.67279657435435, -42.2435340136578],
                  [173.67316135478038, -42.243470473682],
                  [173.6733973891737, -42.2433275085025],
                  [173.67367633891124, -42.243200428070985],
                  [173.67399820399302, -42.2433275085025],
                  [173.67427715373057, -42.24350224367791],
                  [173.674534645796, -42.243565783621705],
                  [173.67489942622203, -42.24348635868195],
                  [173.67524274897593, -42.24335927857036],
                  [173.67547878336924, -42.24329573841862],
                  [173.6757791907789, -42.243152772843175],
                  [173.67603668284434, -42.242993921823825],
                  [173.67612251353282, -42.2426444481735],
                  [173.676337090254, -42.242533251606076],
                  [173.67635854792613, -42.242326743175255],
                  [173.67638000559825, -42.242136119408414],
                  [173.67629417490977, -42.241866068086196],
                  [173.67601522517222, -42.24199315120533],
                  [173.67584356379527, -42.24212023406851],
                  [173.67562898707408, -42.242183775404115],
                  [173.6754144103529, -42.24210434872461],
                  [173.67494234156626, -42.24216789007622],
                  [173.67455610346812, -42.242136119408414],
                  [173.67427715373057, -42.24223143136382],
                  [173.6739767463209, -42.24216789007622],
                  [173.67380508494395, -42.242279087287535],
                  [173.6735261352064, -42.242326743175255],
                  [173.67326864314097, -42.242136119408414],
                  [173.67287167625403, -42.24209640666306],
                  [173.67247470927256, -42.24212023406851],
                  [173.67198118281382, -42.24219966072801],
                  [173.6717236907484, -42.24229497258744],
                  [173.671294537306, -42.24248559587434],
                  [173.67118724894542, -42.2428668407204],
                  [173.671294537306, -42.243200428070985],
                  [173.67144474101084, -42.24337516359833],
                  [173.67159494471568, -42.243692863317335],
                  [173.67178806376475, -42.243962906820656],
                  [173.67191680979747, -42.244328257955985]]]),
            {
              "lakes": 1,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.66655239176768, -42.24575787249618],
                  [173.6663592727186, -42.24575787249618],
                  [173.66616615366954, -42.24585317898035],
                  [173.66627344203013, -42.245980254068606],
                  [173.66648801875132, -42.246059675868786],
                  [173.66670259547251, -42.24591671655647]]]),
            {
              "lakes": 1,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.7275030795411, -42.22121134867491],
                  [173.72769619859017, -42.22132258281213],
                  [173.7279536906556, -42.22132258281213],
                  [173.72799660599983, -42.221131895599775],
                  [173.72799660599983, -42.22092531713653],
                  [173.7276318255738, -42.22090942645752]]]),
            {
              "lakes": 1,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.7966685339908, -41.96048927720156],
                  [173.79651833028598, -41.960393540797455],
                  [173.79630375356479, -41.96024993592161],
                  [173.79623938054843, -41.96005846225039],
                  [173.79617500753207, -41.95989890041821],
                  [173.79604626149936, -41.95972338194133],
                  [173.79572439641757, -41.95967551318192],
                  [173.79533815831942, -41.95969146943906],
                  [173.79514503927035, -41.959851031790635],
                  [173.7952094122867, -41.959994637565465],
                  [173.79557419271273, -41.959851031790635],
                  [173.795981888483, -41.95993081281661],
                  [173.79602480382724, -41.960218023683026],
                  [173.7960891768436, -41.96048927720156],
                  [173.79623938054843, -41.960632881538025],
                  [173.79651833028598, -41.960648837555425],
                  [173.79684019536776, -41.960648837555425]]]),
            {
              "lakes": 1,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.7932996794681, -41.95969146943906],
                  [173.79297781438632, -41.95972338194133],
                  [173.7927203223209, -41.95981911935228],
                  [173.79231262655063, -41.95996272519902],
                  [173.79248428792758, -41.96001059374268],
                  [173.79291344136996, -41.9599148566194],
                  [173.793278221796, -41.9599148566194]]]),
            {
              "lakes": 1,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.78950167150302, -41.95875004343203],
                  [173.78967333287997, -41.95890960814091],
                  [173.79001665563388, -41.95900534677446],
                  [173.79055309743686, -41.959037259620345],
                  [173.79042435140414, -41.95892556458982],
                  [173.79018831701083, -41.95875004343203],
                  [173.78990936727328, -41.95859047832361],
                  [173.7895875021915, -41.95846282594921]]]),
            {
              "lakes": 1,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.78490972966952, -41.95672353687132],
                  [173.78471661062045, -41.95681927878908],
                  [173.7846736952762, -41.95717033125696],
                  [173.78452349157138, -41.957329899921284],
                  [173.7843089148502, -41.95747351137756],
                  [173.78400850744052, -41.95758520895315],
                  [173.7837724730472, -41.957505424990565],
                  [173.7835364386539, -41.95747351137756],
                  [173.78315020055575, -41.95752138179107],
                  [173.7833004042606, -41.95758520895315],
                  [173.78360081167025, -41.95758520895315],
                  [173.78379393071933, -41.9576809495764],
                  [173.78405142278476, -41.95776073331925],
                  [173.78439474553866, -41.9576809495764],
                  [173.78473806829257, -41.957553295380094],
                  [173.78493118734164, -41.957345856765734],
                  [173.78497410268588, -41.9570745898666],
                  [173.7852315947513, -41.956787364832486]]]),
            {
              "lakes": 1,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.78604698629184, -41.95654800964853],
                  [173.78632593602939, -41.95645226732324],
                  [173.78647613973422, -41.956308653565635],
                  [173.78615427465243, -41.95634056776195],
                  [173.785896782587, -41.95646822438745]]]),
            {
              "lakes": 1,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.30041871399715, -42.52055449841991],
                  [173.30067620606258, -42.52049123817278],
                  [173.30063329071834, -42.520317272162934],
                  [173.30076203675105, -42.5201591208246],
                  [173.30129847855403, -42.520143305668746],
                  [173.30162034363582, -42.52012749050889],
                  [173.30179200501277, -42.52000096908595],
                  [173.30174908966853, -42.51981118647118],
                  [173.30142722458675, -42.51981118647118],
                  [173.30134139389827, -42.51995352348629],
                  [173.300933698128, -42.52001678427783],
                  [173.30054746002986, -42.52004841464957],
                  [173.30044017166927, -42.520301457047125],
                  [173.30020413727595, -42.5204596080252]]]),
            {
              "lakes": 1,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.27023300382294, -42.51439596899242],
                  [173.27012571546234, -42.514585768054005],
                  [173.27039393652132, -42.51456995190037],
                  [173.2705119535605, -42.514506685181736]]]),
            {
              "lakes": 1,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.28854712697662, -42.50331149499001],
                  [173.2881823465506, -42.50324821728808],
                  [173.28803214284576, -42.50310584222459],
                  [173.2879463121573, -42.50288436925916],
                  [173.28781756612457, -42.5026470759256],
                  [173.28766736241974, -42.502757812926674],
                  [173.28775319310822, -42.50299510583995],
                  [173.28788193914093, -42.50324821728808],
                  [173.28801068517365, -42.50343805020173],
                  [173.28848275396027, -42.50342223081428]]]),
            {
              "lakes": 1,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.2794761289844, -42.50187517955594],
                  [173.27954050200077, -42.50159042285128],
                  [173.2794546713123, -42.50144804401262],
                  [173.27932592527958, -42.50181190040031]]]),
            {
              "lakes": 1,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.28245874540897, -42.50253960682332],
                  [173.28325267927738, -42.502286492506414],
                  [173.2831668485889, -42.502175754670546],
                  [173.28269477980228, -42.502286492506414]]]),
            {
              "lakes": 1,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.60135679561625, -42.269667853475234],
                  [173.60131388027202, -42.26956067422017],
                  [173.60136752445231, -42.269457464331225],
                  [173.60134606671534, -42.26932249717492],
                  [173.6012924225999, -42.269251044046364],
                  [173.6011851342393, -42.269393950469414],
                  [173.60120659191142, -42.26961624870576],
                  [173.60131388027202, -42.2697432759174]]]),
            {
              "lakes": 1,
              "system:index": "27"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.60148554164897, -42.26871911173542],
                  [173.6014211686326, -42.2688937765713],
                  [173.60132460918646, -42.26900889621503],
                  [173.60133533794414, -42.26912401584277],
                  [173.6014426263696, -42.2691240158568],
                  [173.6015069993211, -42.26902874452209],
                  [173.6015391858029, -42.26881041367949]]]),
            {
              "lakes": 1,
              "system:index": "28"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.60071911397895, -42.27124773498516],
                  [173.6009229618641, -42.271136588841834],
                  [173.6008371311756, -42.27107307667195],
                  [173.60068692747078, -42.27108101569668],
                  [173.6006547409626, -42.27116040588905]]]),
            {
              "lakes": 1,
              "system:index": "29"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.6013735729786, -42.27100956443806],
                  [173.60162033620796, -42.27096986925937],
                  [173.60163106504402, -42.270898417874754],
                  [173.6013950306507, -42.27088253977828],
                  [173.601266284618, -42.27094605214016]]]),
            {
              "lakes": 1,
              "system:index": "30"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.60340132299385, -42.25945651765178],
                  [173.60349788251838, -42.25927388615811],
                  [173.60353006902656, -42.259067432528326],
                  [173.60340132299385, -42.25886097822261],
                  [173.60318674627266, -42.25869422617453],
                  [173.60315455976448, -42.25880539425558],
                  [173.6032296616169, -42.258932443251084],
                  [173.6033369499775, -42.25913889732283],
                  [173.60329403463325, -42.25945651765178]]]),
            {
              "lakes": 1,
              "system:index": "31"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.596662511313, -42.28456637707223],
                  [173.5967697996736, -42.284383818321665],
                  [173.596801986517, -42.284283609085406],
                  [173.59693073269636, -42.28421514927582],
                  [173.59694146109516, -42.28403854258247],
                  [173.5968583124552, -42.283938332720204],
                  [173.59688245231422, -42.283742873959085],
                  [173.5968019861818, -42.283748827243215],
                  [173.59674297784977, -42.28404251144062],
                  [173.5967376133601, -42.28416157217221],
                  [173.59655522295242, -42.28431238214485],
                  [173.59654449400824, -42.2844949409869]]]),
            {
              "lakes": 1,
              "system:index": "32"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.59745644518142, -42.28317732980061],
                  [173.59769247957473, -42.28328051722238],
                  [173.5977246660829, -42.283066204695885],
                  [173.5975422758699, -42.28288364159838],
                  [173.597381343329, -42.283018579591015]]]),
            {
              "lakes": 1,
              "system:index": "33"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.59522262217226, -42.2868333391635],
                  [173.59552302958193, -42.286928583569924],
                  [173.59586635233583, -42.287087323927274],
                  [173.59586635233583, -42.286896835450456],
                  [173.5952655375165, -42.28667459816615]]]),
            {
              "lakes": 1,
              "system:index": "34"
            })]),
    Delineated_Lakes_0119 = 
    /* color: #c7aff5 */
    /* shown: false */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[173.67254589200587, -42.24308789325669],
                  [173.6728033840713, -42.243024352831604],
                  [173.67331836820216, -42.243008467715335],
                  [173.67340419889064, -42.24288138664121],
                  [173.6735758602676, -42.24273842012686],
                  [173.67376897931666, -42.24259545328855],
                  [173.6735973179397, -42.24238894506129],
                  [173.67323253751368, -42.242341289220555],
                  [173.67286775708766, -42.24229363334384],
                  [173.67263172269435, -42.24229363334384],
                  [173.67239568830104, -42.242230092118874],
                  [173.67209528089137, -42.24240483033354],
                  [173.67196653485865, -42.24259545328855],
                  [173.67215965390773, -42.242849616332684],
                  [173.6724600613174, -42.24294492721027]]]),
            {
              "lakes": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.20131092283637, -42.584496907568024],
                  [173.2019117376557, -42.58424412530645],
                  [173.2015684149018, -42.58395974403704],
                  [173.20105343077094, -42.58395974403704],
                  [173.20049553129584, -42.584149331694114],
                  [173.2007959387055, -42.584496907568024]]]),
            {
              "lakes": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.2128980657807, -42.587119463051074],
                  [173.21281223509223, -42.58623475787033],
                  [173.21298389646918, -42.58582399762553],
                  [173.21298389646918, -42.585571220745],
                  [173.21251182768256, -42.58547642915055],
                  [173.21191101286323, -42.58538163741197],
                  [173.21152477476508, -42.58547642915055],
                  [173.21105270597846, -42.58509726133142],
                  [173.21002273771674, -42.585065663909056],
                  [173.20955066893012, -42.58516045612809],
                  [173.20877819273383, -42.585192053502404],
                  [173.2079628011933, -42.585065663909056],
                  [173.20723324034125, -42.58497087154589],
                  [173.2067182562104, -42.58481288395365],
                  [173.20641784880073, -42.58427572314519],
                  [173.2063749334565, -42.583643763327366],
                  [173.20603161070258, -42.58348577237197],
                  [173.20555954191596, -42.58351737059508],
                  [173.20521621916205, -42.58345417413285],
                  [173.20465831968696, -42.58313819086079],
                  [173.2041433355561, -42.58285380454666],
                  [173.20367126676948, -42.582759008820354],
                  [173.20311336729438, -42.582885403090074],
                  [173.20242672178657, -42.58316978926007],
                  [173.20182590696723, -42.58316978926007],
                  [173.20131092283637, -42.58326458436179],
                  [173.20118217680366, -42.58291700161746],
                  [173.2006671926728, -42.58326458436179],
                  [173.19968013975532, -42.583643763327366],
                  [173.1988647482148, -42.58361216516832],
                  [173.1992080709687, -42.58389654802321],
                  [173.2001092931977, -42.58380175388238],
                  [173.20118217680366, -42.58354896880218],
                  [173.20186882231147, -42.58354896880218],
                  [173.202684213852, -42.58386494999228],
                  [173.2037141821137, -42.583833351945344],
                  [173.20452957365424, -42.584149331694114],
                  [173.2052591345063, -42.584086135872475],
                  [173.20513038847358, -42.58456010297327],
                  [173.20513038847358, -42.58490767655703],
                  [173.2057312032929, -42.585192053502404],
                  [173.2065036794892, -42.58566601219531],
                  [173.20714740965278, -42.58607677348109],
                  [173.2079628011933, -42.58617156416268],
                  [173.2087352773896, -42.58639274185919],
                  [173.20959358427436, -42.586550725447665],
                  [173.21023731443793, -42.58620316102451],
                  [173.21105270597846, -42.58613996728482],
                  [173.21169643614203, -42.586266354700136],
                  [173.21229725096137, -42.586550725447665]]]),
            {
              "lakes": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.12548841486807, -42.60921365400471],
                  [173.12604631434317, -42.609434749930074],
                  [173.12626089106436, -42.609687430026675],
                  [173.12613214503165, -42.61000327870594],
                  [173.1265183831298, -42.610066448249604],
                  [173.12681879053946, -42.610066448249604],
                  [173.12711919794913, -42.60971901496667],
                  [173.1274196053588, -42.609182068808465],
                  [173.12802042017813, -42.60896097198619],
                  [173.12840665827628, -42.60839243369673],
                  [173.12844957362051, -42.60788706197193],
                  [173.12819208155508, -42.60760278857492],
                  [173.12784875880118, -42.60700265158762],
                  [173.12746252070303, -42.606749960600084],
                  [173.1275483513915, -42.607255341550136],
                  [173.1277629281127, -42.60763437457199],
                  [173.12780584345694, -42.607981819482646],
                  [173.1275483513915, -42.60826609114992],
                  [173.1270762826049, -42.60851877598728],
                  [173.12681879053946, -42.60883463059255],
                  [173.12660421381827, -42.60905572786326],
                  [173.12613214503165, -42.60905572786326],
                  [173.1255313302123, -42.6089293866618]]]),
            {
              "lakes": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.1508513833129, -42.61518296852586],
                  [173.15166677485342, -42.61518296852586],
                  [173.15256799708243, -42.61518296852586],
                  [173.1530829812133, -42.614835563784],
                  [173.15372671137686, -42.614456574582604],
                  [173.15402711878653, -42.61426707911703],
                  [173.15351213465567, -42.61423549648337],
                  [173.1528684044921, -42.61458290457268],
                  [173.15239633570548, -42.614835563784],
                  [173.15170969019766, -42.614835563784],
                  [173.15102304468985, -42.61496189300527]]]),
            {
              "lakes": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.16226686488028, -42.59815785713741],
                  [173.16235269556876, -42.597715584454434],
                  [173.16235269556876, -42.59702057818184],
                  [173.16188062678214, -42.59698898680346],
                  [173.16188062678214, -42.59736808228708],
                  [173.16192354212637, -42.59784194839845]]]),
            {
              "lakes": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.16256727228995, -42.596167605343915],
                  [173.16269601832266, -42.59585168651514],
                  [173.16316808710928, -42.595598950299],
                  [173.16355432520743, -42.59531462083065],
                  [173.16346849451895, -42.59484073550061],
                  [173.16303934107657, -42.59499869767767],
                  [173.16265310297842, -42.59537780526907],
                  [173.16226686488028, -42.595662134449114],
                  [173.1621810341918, -42.596072829863445]]]),
            {
              "lakes": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.17694391260977, -42.60415981887865],
                  [173.1775447274291, -42.604222994348255],
                  [173.17823137293692, -42.60412823111982],
                  [173.17827428828116, -42.60346488448481],
                  [173.17870344172354, -42.60276994233926],
                  [173.17870344172354, -42.6022961137047],
                  [173.1788751031005, -42.60172751458654],
                  [173.1788751031005, -42.60112732099893],
                  [173.17840303431387, -42.601822281466596],
                  [173.17801679621573, -42.60232770239246],
                  [173.17801679621573, -42.60270676539618],
                  [173.17784513483878, -42.60302264947088],
                  [173.1777593041503, -42.60343329637362],
                  [173.17733015070792, -42.603812352650685]]]),
            {
              "lakes": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.19042924216964, -42.611538769305675],
                  [173.19070819207042, -42.61161772972108],
                  [173.19103005698898, -42.61150718528845],
                  [173.19163087180831, -42.6114598092326],
                  [173.1912875490544, -42.61119134423539],
                  [173.19055798820236, -42.61128609671948]]]),
            {
              "lakes": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.18759682944992, -42.62012902733188],
                  [173.18828347495773, -42.62025534581466],
                  [173.18841222099044, -42.62003428830162],
                  [173.18789723685958, -42.61981323000375],
                  [173.18742516807296, -42.61984480980864]]]),
            {
              "lakes": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.20053580573776, -42.61297582514586],
                  [173.20075038245895, -42.61289686689464],
                  [173.2008147554753, -42.61264419981804],
                  [173.20060017875412, -42.612596824627076],
                  [173.2004714327214, -42.61270736668329],
                  [173.20044997504928, -42.61286528356611]]]),
            {
              "lakes": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.26364170253694, -42.55828474894216],
                  [173.2645858401102, -42.55809508264964],
                  [173.26544414699495, -42.55796863813436],
                  [173.2659591311258, -42.557778970881024],
                  [173.26531540096224, -42.55739963464486],
                  [173.26419960201204, -42.55698868445345],
                  [173.26467167079866, -42.55746285751102],
                  [173.2645000094217, -42.557842193362845]]]),
            {
              "lakes": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.2629121416849, -42.554396474719105],
                  [173.26316963375032, -42.55366937216451],
                  [173.26278339565218, -42.55322678385333],
                  [173.26267610862305, -42.55390646940042],
                  [173.2624829882425, -42.55433324874626]]]),
            {
              "lakes": 1,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.26231132686556, -42.555597756032164],
                  [173.26231132686556, -42.555281631612736],
                  [173.26196800411165, -42.55518679397464],
                  [173.26183925807894, -42.555439694022624]]]),
            {
              "lakes": 1,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.2464867288429, -42.56902334170645],
                  [173.24676567897185, -42.5688021021771],
                  [173.24683005159682, -42.56858086229547],
                  [173.24679786486033, -42.56837542409539],
                  [173.24667984789198, -42.5682015917307],
                  [173.24658328850336, -42.56842283298606],
                  [173.2465940172035, -42.56861246807178],
                  [173.24644381349867, -42.56884951037115]]]),
            {
              "lakes": 1,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.24721628969496, -42.5650567177984],
                  [173.24737722257964, -42.56492238527756],
                  [173.24740940874403, -42.56464581803661],
                  [173.24732357805556, -42.56442456319775],
                  [173.24710900120118, -42.564732738166214],
                  [173.2470768146203, -42.56492633563878]]]),
            {
              "lakes": 1,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.214298414689, -42.58819168941033],
                  [173.2141696686563, -42.587844134136446],
                  [173.21352593849272, -42.58778094206027],
                  [173.2136117691812, -42.58809690180055],
                  [173.21399800727934, -42.588286476875986]]]),
            {
              "lakes": 1,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.1538636868166, -42.58760705512641],
                  [173.15343453337422, -42.58744907421501],
                  [173.1531770413088, -42.58710151480061],
                  [173.15279080321065, -42.586943532608],
                  [173.15253331114522, -42.58716470756555],
                  [173.1528337185549, -42.58744907421501],
                  [173.1529624645876, -42.587670247378874],
                  [173.1533057873415, -42.587670247378874]]]),
            {
              "lakes": 1,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[173.30046173231693, -42.52050019658938],
                  [173.30059047834965, -42.520310415490925],
                  [173.30091234343143, -42.520215524725536],
                  [173.30127712385746, -42.520168079288815],
                  [173.3015346159229, -42.52010481865045],
                  [173.30183502333256, -42.51994666677436],
                  [173.30172773497196, -42.51980432974363],
                  [173.30136295454594, -42.51993085156474],
                  [173.30112692015263, -42.519994112379216],
                  [173.30084797041508, -42.52007318830726],
                  [173.3005475630054, -42.52018389443839],
                  [173.30029007093998, -42.52037367592112],
                  [173.30005403654667, -42.52035786081958],
                  [173.29979654448124, -42.520294600373376],
                  [173.29956051008793, -42.52023133986311],
                  [173.29971071379276, -42.52038949101867],
                  [173.2999896635303, -42.520468566446326],
                  [173.3003115286121, -42.5205160116549]]]),
            {
              "lakes": 1,
              "system:index": "18"
            })]);
/** 
 * Call external repos for exported functions and define distinct 
 * variables that will be used throughout the script
 */
// Import masking S2 clouds module
var cloud_masks = require('users/fitoprincipe/geetools:cloud_masks');
var maskS2clouds = cloud_masks.sentinel2();
// Import the SIAC atmospheric correction module
var siac = require('users/marcyinfeng/utils:SIAC');
// Import script with useful functions
var f = require('users/loreabad6/KaikouraDammedLakes_public:utils');
// Define suffix according to the percentile composite made
var perc = 50;
var suffix = '_p' + perc;
// Defining input and output bands, mainly to rename
var inBands = ee.List(['B2','B3','B4','B8','B11','B12']);
var outBands = ee.List(['blue','green','red','nir','swir1','swir2']);

/**
 * Set of functions specific to this case study
 */
// Clip image to AOI
function clipperK(image) {
  return image.clip(kaikoura);
}

// Generate indices on the images 
var addIndex = function(image) {
  var ndvi = image.normalizedDifference(['nir'+suffix,'red'+suffix]).rename('NDVI');
  var ndwi = image.normalizedDifference(['green'+suffix,'swir1'+suffix]).rename('NDWI'); //mndwi
  var ndwi2 = image.normalizedDifference(['green'+suffix,'nir'+suffix]).rename('NDWI2');
  var msavi2 = image.select('nir'+suffix).multiply(2).add(1)
                .subtract(image.select('nir'+suffix).multiply(2).add(1).pow(2)
                .subtract(image.select('nir'+suffix).subtract(image.select('red'+suffix))
                .multiply(8)).sqrt()).divide(2).rename('MSAVI2');
  // AWEInsh 
  var awei1 = (image.select('green'+suffix).subtract(image.select('swir1'+suffix))).multiply(4)
              .subtract(image.select('nir'+suffix).multiply(0.25)
              .add(image.select('swir2'+suffix).multiply(2.75))).rename('AWEI1');
  // AWEIsh              
  var awei2 = image.select('blue'+suffix).add(image.select('green'+suffix).multiply(2.5))
              .subtract((image.select('nir'+suffix).add(image.select('swir1'+suffix))).multiply(1.5))
              .subtract(image.select('swir2'+suffix).multiply(0.25)).rename('AWEI2');
  var evi = (image.select('nir'+suffix).subtract(image.select('red'+suffix))).multiply(2.5)
              .divide(image.select('nir'+suffix).add(image.select('red'+suffix).multiply(6))
              .subtract(image.select('blue'+suffix).add(1))).rename('EVI');
  return image.addBands([ndvi, ndwi, ndwi2, msavi2, awei1, awei2, evi]).copyProperties(image);
};

/**
* Obtain pre & post event images per month during the Southern Summer (Nov-Feb).
* Different months were selected for each year according to an initial analysis
* of the images' suitability.
*/
var yearly = function(year){
  // List of selected months for each study year
  var months = ee.List(
    ee.Algorithms.If(
      year == 2015, [12], //Pre-event - Oct: no images, Nov: incomplete
        ee.Algorithms.If(
        year == 2016, [2,4,12], //Pre-event - Jan/Mar: cloudy; Oct: cloudy and patchy; Nov: Event month, exclude
        ee.Algorithms.If(
          year == 2017, [1,2,10,11,12], // Jan/Oct consider removing //1,2,10,11,12
          ee.Algorithms.If(
            year == 2018, [1,2,3,10,11], // Nov has some shadows that makes things difficult //1,2,3,10,11
            ee.Algorithms.If(
              year == 2019, [1,2,3], // Oct to Dec are not complete or too many clouds. Not optimal
              ee.Algorithms.If(
                year == 2020, [1,2,3], // Nov. Incomplete, Dec/Oct patchy
                [2, 3] // 2021 Jan: patchy
  ))))))).getInfo();
  // Map a function to the sentinel 2 collection to get composites per month
  var monthly = months.map(function(month){
    // Filter by year
    var month_img = s2.filterDate(year+'-01-01', (year+1)+'-01-01')
                    // Remove conflictive data
                    .filter(ee.Filter.neq('system:index','20171001T222541_20171001T222535_T59GQN'))
                    // Filter by month
                    .filter(ee.Filter.calendarRange(month,month,'month'))
                    // Filter the bounds
                    .filterBounds(kaikoura)
                    // Get images below a threshold of cloudy pixels
                    .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 30))
                    // Mask clouds and shadows
                    .map(maskS2clouds);
    // Add the images out of which the mosaic is made of
    var scenes = month_img.aggregate_array('system:index');
    // print(scenes);
    // print('satellite',month_img.aggregate_histogram('SPACECRAFT_NAME'));
    // print('tile',month_img.aggregate_histogram('MGRS_TILE'));
    /**
     * Atmoshperic correction !! 
     * Given the short range of Sentinel-2 L2A imagery available for the study area
     * i.e., January 2019 - today, we used L1C (imported as s2 above). 
     * There is the possibility to correct the imagery on the fly, 
     * however, due to the large ampunt of memory required to 
     * do so, and the large amount of scenes analyzed for this study area, we have 
     * decided to not apply this correction. 
     * If this code is being reproduced, and future users are interested in testing 
     * with a smaller amount of images before the availability of Sentinel-2 L2A, 
     * please uncomment the lines below. 
     * If the analysis is done for a period where S2 L2A is available, we highly 
     * recommend using that collection instead, since the atmospheric correction 
     * is performed by ESA with the sen2cor algorithm.
     */
    // var month_img = month_img.map(function(image){ 
    //     return siac.get_sur(image);
    // });
    // Rename bands, clip to AOI
    // Reduce collection to the 50th percentile: median
    // This approach still shows clouds, however these don't affect the water detection process, 
    // and rather removes unwanted cloud shadows
    // Set month and year to metadata.
    return month_img
                .select(inBands,outBands)
                .map(clipperK)
                .reduce(ee.Reducer.percentile([perc]))
                .set({
                  'month': month,
                  'year': year,
                  'date': ee.Date.fromYMD(year,month,1),
                  'scenes': scenes,
                  'system:time_start': ee.Date.fromYMD(year,month,1).millis()
                });
                
  });
  return monthly;
};
// Apply the function to each year under analysis
var y15 = ee.ImageCollection(yearly(2015));
var y16 = ee.ImageCollection(yearly(2016));
var y17 = ee.ImageCollection(yearly(2017));
var y18 = ee.ImageCollection(yearly(2018));
var y19 = ee.ImageCollection(yearly(2019));
var y20 = ee.ImageCollection(yearly(2020));
var y21 = ee.ImageCollection(yearly(2021));
// Merge the collection together, and generate index. 19 study periods.
var collection = y15
                  .merge(y16)
                  .merge(y17)
                  .merge(y18)
                  .merge(y19)
                  .merge(y20)
                  .merge(y21)
                  .map(addIndex);
 
exports.s2Col = collection;

/**
* Extract water from the images. This method uses Gena Donchyts method 
* to apply a dynamic threshold to the values. Additionally, it uses the 
* vertical distance (`nz_vdist`) above the river drainage to get rid 
* of false positives. The threshold is based on the NDWI index. 
* 
* Donchyts uses the Height Above Nearest Drainage (HAND), which he calculated and made
* available for the whole world based on SRTM DEM - 30 m. However, New Zealand 
* is not included on this calculations. According to SAGA the Vertical Distance to 
* Channel Network should be the closest approximate to the HAND algorithm. 
* 
* These algorithms are based on the DEM. For this study, a 15 meter DEM based on Land 
* Information New Zealand (LINZ) contours, probably dated around 2011. The DEM 
* was developed by Landcare Research by Stephen McNeill (mcneills@landcareresearch.co.nz)
* 
* To calculate HAND, the software TauDEM can be used, however due to time limitations 
* to get acquantaited with the software, the SAGA approach was preferred. 
* To calculate the dertical distance on SAGA-GIS v. 2.3.2 the following steps took place:
* 1. Load the 15 meter resolution DEM previously clipped to the study area.
* 2. DEM to Terrain Analysis module -> Preprocessing -> Fill Sinks (Wang & Liu)
* 3. Filled DEM to Terrain Analysis module -> Hydrology -> Flow Accumulation -> 
*       Flow Accumulation (Top-Down): Deterministic 8 method
* 4. Terrain Analysis module -> Channel -> Channel Network:
*       Elevation: Filled DEM
*       Initiation Grid: Flow Accumulation
*       Initiation Threshold: 1000000
* 5. Terrain Analysis module -> Channel -> Vertical Distance to Channel Network 
*       Elevation: Filled DEM
*       Channel Network: Channel Network
* 
* This approach is coded in R using RSAGA here:
* https://github.com/loreabad6/KaikouraDammedLakes_public/blob/master/pre_processing/rsaga/vdcn_procedure.md
*/
// Variables to map the otsu threshold, given high differences between study months, 
// the process is divided to reduce the large number of features oddly detected
var debug = false;
var scale = 40; 
var cannyThreshold1 = 0.9; //Oct, Nov, Dec
var cannyThreshold2 = 3.5; //Mar
var cannyThreshold3 = 2.0; //Jan Feb
var cannySigma = 0.1;
var minValue = 0; 

// vdist refers to the vertical distance, a threshold of 15 meters is set next
var vdist = nz_vdist.select('b1');

// Map the function to extract an NDWI water mask 
var water = collection.map(function(img){
  // Select index to base thresholding on 
  var ndwi = img.select('NDWI');
  var index2 = img.select('MSAVI2');
    // Function to add a water band to the analysis
  var waterMask = function(image) {
    var cannyThreshold = ee.Algorithms.If(
      ee.Number(image.get('month')).gt(9),
      cannyThreshold1,
      // cannyThreshold3
      ee.Algorithms.If(
        ee.Number(image.get('month')).eq(3),
        cannyThreshold2, cannyThreshold3
      )
    );
    // Obtain variable threshold per image
    var wth = f.computeThresholdUsingOtsu(
      ndwi, scale, kaikoura, cannyThreshold, cannySigma, minValue, debug
    );
    var water = ndwi.gt(wth).and(vdist.lt(15)).rename('water'); //.and(index2.lt(-0.015))
    return image.addBands([water.updateMask(water.eq(1))])
                  .set('cannyt', cannyThreshold).set('ndwit', wth);
  };
  var water_img = waterMask(img);
  var ndwi_water = water_img.select('NDWI').mask(water_img.select('water')
                    .eq(1)).rename('waterNDWI');
  // The result is unmasked in order to generate difference among pre and post events 
  // that also include new water features
  return clipperK(img.addBands(ndwi_water.unmask(-2))).copyProperties(water_img);
});

// Map the function to create one image with bands corresponding to the NDWI value per timestep
// Set band names
var bandnamestimestamp = ee.List([
                    'lake201512', 'lake201602', 'lake201604', // 0,  1,  2,
                    'lake201612', 'lake201701', 'lake201702', // 3,  4,  5,
                    'lake201710', 'lake201711', 'lake201712', // 6,  7,  8,
                    'lake201801', 'lake201802', 'lake201803', // 9, 10, 11,
                    'lake201810', 'lake201811', 'lake201901', //12, 13, 14,
                    'lake201902', 'lake201903', 'lake202001', //15, 16, 17,
                    'lake202002', 'lake202003', 'lake202102', //18, 19, 20
                    'lake202103'                              //21
                    ]);
                    
var ndwicol = water.map(function(img){
  // Select the band
  return img.select('waterNDWI');
}).toBands().rename(bandnamestimestamp);

// Remove all those pixels within 150 meters inland from the coastline,
// and all those outland from the coastline.
// The water change detected in these areas is due to the change in tides.
var coastbuffer1 = coast.filterBounds(kaikoura)
                    .map(function(feature){return feature.buffer(0.1)});
// Compute the difference
var aoi_split = kaikoura.geometry().difference(coastbuffer1, ee.ErrorMargin(1));
var kaikoura_coast = ee.FeatureCollection(ee.Geometry.Polygon(
  aoi_split.coordinates().get(1))
);

var coastbuffer2 = coast.filterBounds(kaikoura)
                    .map(function(feature){return feature.buffer(150)});
var coastraster2 =  coastbuffer2.reduceToImage({
  properties: ['t50_fid'],
  reducer: ee.Reducer.first()
}).gt(0).unmask(2);
var coastmask = coastraster2.gt(1);

/**
* Use the JRC Water Occurence layer as a pre-event, to get rid of rivers, and pre-existent
* lakes. This layer for now on the Earth Engine contains water only up to 2015. 
* Only the Southern Summer months (november to march) were selected to get the water 
* occurence for the fifteen previous years before the event. 
* This layer is based on Landsat, so 30 meter resolution, however to get a sense of pre-existing
* water it should be a good approach.
*/
var jrcwater = gsw
                  .filter(ee.Filter.date('2000-11-01', '2016-03-31'))
                  .filter(ee.Filter.calendarRange(11,3,'month')).select('water');
var waterfull = jrcwater.map(function(img){
  return img.mask(img);
});
var water2000_2016 = waterfull.toBands().gt(1).reduce('mean');
var waterMax = water2000_2016.focal_max(2, 'square','pixels');

// Only get those water areas where there has been water less than 80% of the time: 
// temporal water bodies
var JRCmask = waterMax.lt(0.8);

/**
* Compute the differences between pre-and post event images to detect lakes
*/
// Extract pre-event water as NDWI values as a variable
var preWater1 = water
                 .filterMetadata("month", "equals", 12)
                 .first().select('waterNDWI');
var preWater2 = water
                 .filterMetadata("month", "equals", 2)
                 .first().select('waterNDWI');
var preWater3 = water
                 .filterMetadata("month", "equals", 4)
                 .first().select('waterNDWI');
// Function to extract lakes
var lakes = water.map(function(img){
  var preWater = ee.Algorithms.If(
    ee.Number(img.get('month')).gt(9),
    preWater1,
    ee.Algorithms.If(
      ee.Number(img.get('month')).lte(2),
      preWater2,
      preWater3
    )
  );
  var diff_abs = img.select('waterNDWI').subtract(preWater);
  // Threshold to only get significant positive changes, that is 
  // where the NDWI increased in relation to the pre-event
  var diff_mask = diff_abs.gt(0);
  var lake = diff_mask.mask(diff_mask.eq(1))
                      // .updateMask(coastmask).updateMask(JRCmask)
                      // .focal_max(1, 'square','pixels')
                      .rename('lake');
  var diff = diff_abs.updateMask(diff_mask.eq(1)).rename('lakeDiff');
  return img.addBands([diff, lake]).copyProperties(img);
});

/**
* Post-processing
* Remove false positives by deleting those areas where water is registered only once 
* in the 19 time periods, where coastlines could be a subject to water change. Sometimes
* where previously exisiting lakes that were dry during the pre-event, or had different
* spectral signal, might be getting detected.
*/

// Map the function to create one image with bands corresponding to the 
// detected water changes per timestep
var lakecol = lakes.map(function(img){
  // Select the band
  return img.select('lake');
}).toBands().rename(bandnamestimestamp);
// Map.addLayer(lakecol, {bands: "lake201803"}, "lakes");              

// Create an image with the Water occurence for all the study periods
var lakeperc = lakecol.unmask(0).reduce('sum');
// Map.addLayer(lakeperc, {palette: ['cyan', 'red', 'purple'], min: 0, max: 15});

// Extract a buffer around those pixels that happen more than once, 
// this will be used when vectorizing to get rid of cloud-shadow/shadow errors.
var lakepercmask = lakeperc.gt(1).focal_max(1, 'square');

// Create a mask for the final lakes
var lakepercmask = lakepercmask.mask(lakepercmask);
                      //.updateMask(coastmask).updateMask(JRCmask)


// Create connected components
var lakesConnected = lakes.map(function(img){
  var lake = img.select('lake')
                  .updateMask(lakepercmask)
                  .updateMask(coastmask)
                  .updateMask(JRCmask)
                  .clip(kaikoura_coast);
  var connlake = lake.addBands([ee.Image.pixelArea(),vdist.rename('vdcn')])
                      .connectedComponents(ee.Kernel.square(2), 256);
  var connMean = img.addBands(connlake).reduceConnectedComponents(ee.Reducer.mean(), 'labels', 256);
  var connNDWI = connMean.select(['waterNDWI']).rename(['meanMNDWI']);
  var connIndex = connMean.select(['NDVI','NDWI2','EVI','MSAVI2','AWEI2','AWEI1'])
                          .rename(['meanNDVI','meanNDWI2','meanEVI','meanMSAVI2','meanAWEI2','meanAWEI1']);
  var connMinMax = img.addBands(connlake).reduceConnectedComponents(ee.Reducer.minMax(), 'labels', 256);
  var connVDCN = connMinMax.select(['vdcn_min','vdcn_max']).rename(['minVDCN','maxVDCN']);
  var connSum = img.addBands(connlake).reduceConnectedComponents(ee.Reducer.sum(), 'labels', 256);
  var connArea = connSum.select('area').rename('sumArea');
  var connMask = lake.mask(connArea.lte(110000)
                            .and(connArea.gte(300))
                            .and(connNDWI.gt(0.06))
                            .and(connNDWI.lt(0.8))
                            .and(connVDCN.select('maxVDCN').gt(1))
                            //.and(connVDCN.select('maxVDCN').lt(14))
                          )
                    .rename('connMask');
  return img.addBands([connNDWI,connIndex,connVDCN,connArea,connMask]).copyProperties(img);
});

// Map the function to create one image with bands corresponding to the 
// detected water changes per timestep
// Create an image containing the pixel results in bands
var lake_img = lakesConnected
                  .map(function(img){
                    return img.select('connMask');
                  }).toBands()
                  .rename(bandnamestimestamp);
// Create a lake occurrence layer, how many times has there been water per pixel?
var lakeoccurrence = lake_img.unmask(0).reduce('sum');
// Create an image containing areasum per connected component in bands
var lake_sum = lakesConnected
                  .map(function(img){
                    return img.select('sumArea');
                  }).toBands()
                  .rename(bandnamestimestamp);
/**
 * Quick validation
 * Uncomment to have a quick validation result
 */
 
// Buffer dams
// var dams_buffer = ee.FeatureCollection([keydams, otherdams])
//                 .flatten()
//                 .map(function(feature) {
//                   return ee.Algorithms.If(
//                     ee.String(feature.get('SCALE')).match('Large'), 
//                     feature.buffer(500), 
//                     ee.Algorithms.If(
//                       ee.String(feature.get('SCALE')).match('Small'), 
//                       feature.buffer(300),
//                       feature.buffer(400)
//                     ));
//                 });
             
// var damsLakes = dec16.select('connMask')
//                   .focal_max(1, 'square','pixels')
//                   .rename('result').reduceRegions({
//   collection: dams_buffer,//.filter(ee.Filter.lte('Last_Check', 1482912000000)), // Dec. 28 2016
//   crs: 'EPSG:4326',
//   reducer: ee.Reducer.mean(),
//   scale: 10,
//   tileScale: 2
// });

// Map.addLayer(dams_buffer.filter(ee.Filter.lte('Last_Check', 1482912000000)), {color:'green'}, 'dams from December 2016');
// print('No. Lakes intersecting 196 GNS dams for Dec. 2016', //and 19 lakes larger than 1000m2 
//           damsLakes.aggregate_array('mean').size());
// print('Detected GNS dams',
//       damsLakes.filter(ee.Filter.eq('mean',1)).aggregate_array('OBJECTID_1'));
// print('From the GNS dams, 7 have no visible lakes on Google Earth Pro.',
//       'From the ones that have lakes, 14 are smaller than 600 m2.'); //19 have a lake larger than 1000m2 (GEP)

/**
* Exporting the results and validation areas for accuracy assessment in R:
* https://github.com/loreabad6/KaikouraDammedLakes_public/blob/master/validation/accuracy_assessment.R
* Also, export as asset for further inspection
*/
// Export.image.toAsset({
//   image: lake_img,
//   description: 'kaikoura_mapping_results_pixel',
//   region: kaikoura,
//   assetId: 'Kaikoura_landslidedammedlakes_update/dammedLakes_pixelwise',
//   scale: 10,
//   maxPixels: 400000000,
//   pyramidingPolicy: {'.default': 'mean'}
// });
// Export.image.toAsset({
//   image: lake_sum,
//   description: 'kaikoura_mapping_results_comp',
//   region: kaikoura,
//   assetId: 'Kaikoura_landslidedammedlakes_update/dammedLakes_components',
//   scale: 10,
//   maxPixels: 400000000,
//   pyramidingPolicy: {'.default': 'max'}
// });
// Export.image.toAsset({
//   image: lakeoccurrence,
//   description: 'kaikoura_mapping_results_occurrence',
//   region: kaikoura,
//   assetId: 'Kaikoura_landslidedammedlakes_update/dammedLakes_occurrence',
//   scale: 10,
//   maxPixels: 400000000,
//   pyramidingPolicy: {'.default': 'mean'}
// });
// Export.image.toDrive({
//   image: lake_img,
//   description: 'mapping_results_update',
//   folder: 'Z_GIS',
//   region: kaikoura,
//   scale: 10,
//   maxPixels: 400000000
// });
// Export.table.toDrive({
//   collection: Delineated_Lakes_1216,
//   folder: 'Z_GIS',
//   description: 'validation_data_2016'
// })
// Export.table.toDrive({
//   collection: Delineated_Lakes_0318,
//   folder: 'Z_GIS',
//   description: 'validation_data_2018'
// })
// Export.table.toDrive({
//   collection: Delineated_Lakes_0119,
//   folder: 'Z_GIS',
//   description: 'validation_data_2019'
// })
// Export.table.toDrive({
//   collection: validation_areas,
//   folder: 'Z_GIS',
//   description: 'validation_areas'
// })